# 高并发大流量的业务分析

### 1.  相关概念
- PV：Page View，网页浏览量。网页被读者调用浏览的次数。网页每次打开或刷新一次页面，记录一次。用户对同一页面的多次访问，访问量累计。
- UV：Unique Visitor，独立访问者。是指通过互联网访问、浏览这个网页的自然人。在一定时间内，访问网站的不同访客的数量，且每个访客只被统计一次。同一个客户端的电脑，00:00~24:00访问页面多次，只计算1次。例如，假设用户周三访问3次，周四访问1次，则周三记为1次UV，周四也记为1次UV。一般通过Cookies进行计算。
- TPS：Transactions Per Second（每秒传输的事物处理个数），即服务器每秒处理的事务数。PS包括一条消息入和一条消息出，加上一次用户数据库访问。
- QPS（或Queries  Request Per Second）：Queries Per Second。每秒查询率。在规定时间内所处理流量多少的衡量标准。对应fetches/sec，即每秒的响应请求数（HTTP请求），也即是最大吞吐能力。
- 响应时间：从请求发出到响应返回请求所花费的时间。

### 2. 高并发的问题，主要关心QPS的峰值，分析出业务的峰值

峰值QPS计算 （总PV数 * 0.8） / （6 * 3600 * 0.2） = 峰值每秒请求数（QPS）

### 3. 进行单机服务器的压力测试，计算出单机能够承受的QPS的量，在于需求量做对比分析，从而给出解决方案
- 压力测试工具 ab(apache benchmark),wrk,http_load,apache jmeter；
- 不要对线上业务进行测试，被测试机器不要超过各项指标的75%：cpu 内存 网络带宽
```bach
# 使用工具 ab , 能对nginx ，apache，tomcat等进行压力测试，基于http测试，简单方便
yum -y install ab
# -c 并发数 -n 请求数，测试地址http:www.baidu.com （测试是不要在被测试的的机器上进行，需要把工具和被测试服务器分离开）
ab -c 100 -n 5000 http:www.baidu.com

Requests per second: 505.34 [#/sec] (mean)

QPS 505.34 得出单台服务器的承受量（多测试几组参数，然后对比服务器的资源占用情况然后得出一个较准确的值）
```


### 4. 随着QPS的增长，每个阶段的优化方案也不通，与优化使用的硬件和网络带宽等息息相关
- 50 ： 基本上不需要优化
- 100 ：假设服务器每个请求勇士 0.01 秒，数据库查询就需要在1秒钟内需要查询100次，数据库此时需要优化，做数据库的负载等。
- 800 ：百兆带宽，意味着网络出口的带宽是 10 M 左右，此时每个页面 10 kb ，那800 就是8M ，此时急需要在带框方面优化。使用CDN和服务器负载
- 1000 ： 测试对数据的请求量巨大，即使做了数据的memcache缓存也可能导致并发问题，此时就需要做页面的静态化处理。
- 2000 ：基本上会带来灾难性的问题，此时需要做 文件系统的升级，采用高转数磁盘，做磁盘整列，上存储服务器，做业务分离，负载均衡等。


### 5.  流量优化
- 防盗链处理 （资源被外站盗用可能会导致本站流量的提升，需要做防盗链处理）

### 6. 前端优化
- 减少HTTP请求（css,jss 文件图片，图片压缩，根据设备显示不通大小的图片）
- 异步请求，这样可以把请求就不会一次全部进来，减轻同一时间点的访问压力
- 启用浏览器的缓存和压缩
- CDN加速
- 建立独立的图片和视频服务器（cpu计算降低，I/O性能提高）

### 7. 服务端优化
- 页面静态化处理 （将数据生成为html文件）
- 高并访问的的数据 （多进程异步和队列处理来加载数据）

### 8. 数据库优化
- 做数据缓存 redis等
- 数据库本身的查询缓存
- 分库分表，表分区等
- 读写分离，负载均衡

### 9. WEB服务器优化
- 负载均衡